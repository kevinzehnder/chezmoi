#!/bin/bash
# run_once_install-rhel-packages.sh.tmpl
# This script runs once when chezmoi apply is first executed on RHEL/Alma Linux systems.
# It handles being run as root or as a regular user with sudo privileges.
set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RED='\033[0;31m'
NC='\033[0m'

# Check if running on RHEL/Alma Linux/CentOS
if ! grep -E "Red Hat|CentOS|AlmaLinux|Rocky Linux" /etc/os-release &> /dev/null; then
    echo -e "${RED}This script is designed for RHEL/Alma/CentOS Linux only. Exiting.${NC}"
    exit 0
fi

# --- Helper Functions ---
# Installs packages using dnf/yum.
install_packages() {
    echo -e "${YELLOW}Updating system and installing packages...${NC}"
    
    # Package list organized into a Bash array for better readability and management.
    local packages=(
        # --- Core System Utilities ---
        "git"              # Version control
        "golang"           # Go programming language
        "sudo"             # Privilege escalation
        "unzip"            # For extracting zip files
        "which"            # To find command locations
        "zsh"              # The Z shell
        "make"             # Build tool
        "gcc"              # C compiler
        "gcc-c++"          # C++ compiler
        "epel-release"     # Extra Packages for Enterprise Linux
    )
    
    echo -e "${YELLOW}Installing packages: ${packages[*]}${NC}"
    
    if [ "$EUID" -eq 0 ]; then
        if command -v dnf &> /dev/null; then
            dnf update -y
            dnf install -y "${packages[@]}"
            # Ensure EPEL is updated
            dnf update -y
        else
            yum update -y
            yum install -y "${packages[@]}"
            # Ensure EPEL is updated
            yum update -y
        fi
    else
        if command -v dnf &> /dev/null; then
            sudo dnf update -y
            sudo dnf install -y "${packages[@]}"
            # Ensure EPEL is updated
            sudo dnf update -y
        else
            sudo yum update -y
            sudo yum install -y "${packages[@]}"
            # Ensure EPEL is updated
            sudo yum update -y
        fi
    fi
    
    # Install additional utilities from EPEL
    install_modern_cli_tools
    
    echo -e "${GREEN}Packages installed successfully.${NC}"
}

# Install modern CLI tools on RHEL-based systems
install_modern_cli_tools() {
    echo -e "${YELLOW}Installing modern CLI tools...${NC}"
    
    # List of tools to install from EPEL
    local tools=(
        "fzf"      # Fuzzy finder
        "ripgrep"  # Modern grep replacement
    )
    
    # Install tools
    echo -e "${YELLOW}Installing tools: ${tools[*]}${NC}"
    
    if [ "$EUID" -eq 0 ]; then
        if command -v dnf &> /dev/null; then
            dnf install -y "${tools[@]}" || echo -e "${YELLOW}Some tools may not be available in repositories.${NC}"
        else
            yum install -y "${tools[@]}" || echo -e "${YELLOW}Some tools may not be available in repositories.${NC}"
        fi
    else
        if command -v dnf &> /dev/null; then
            sudo dnf install -y "${tools[@]}" || echo -e "${YELLOW}Some tools may not be available in repositories.${NC}"
        else
            sudo yum install -y "${tools[@]}" || echo -e "${YELLOW}Some tools may not be available in repositories.${NC}"
        fi
    fi
    
    # Install Starship prompt
    if ! command -v starship &> /dev/null; then
        echo -e "${YELLOW}Installing Starship prompt...${NC}"
        if [ "$EUID" -eq 0 ]; then
            curl -sS https://starship.rs/install.sh | sh -s -- -y
        else
            curl -sS https://starship.rs/install.sh | sudo sh -s -- -y
        fi
    fi
}

# Sets ZSH as the default shell for a user.
# $1: The username to change the shell for.
set_default_shell() {
    local user_to_set_shell_for="$1"
    local shell_path
    shell_path=$(which zsh)
    
    echo -e "${YELLOW}Setting ZSH as default shell for user '$user_to_set_shell_for'...${NC}"
    
    # Get the current default shell for the target user from /etc/passwd
    local current_shell
    current_shell=$(getent passwd "$user_to_set_shell_for" | cut -d: -f7)
    
    if [ "$current_shell" != "$shell_path" ]; then
        if [ "$EUID" -eq 0 ]; then
            chsh -s "$shell_path" "$user_to_set_shell_for"
        else
            # chsh requires root privileges to change another user's shell,
            # or no privileges to change one's own shell (but may ask for password).
            sudo chsh -s "$shell_path" "$user_to_set_shell_for"
        fi
        echo -e "${GREEN}Default shell for '$user_to_set_shell_for' has been set to ZSH.${NC}"
    else
        echo -e "${GREEN}ZSH is already the default shell for '$user_to_set_shell_for'.${NC}"
    fi
}

# --- Main Execution ---
echo -e "${YELLOW}Starting RHEL/Alma Linux environment bootstrap...${NC}"

if [ "$EUID" -eq 0 ]; then
    # When run as root, we need the actual username for user-specific tasks.
    # chezmoi provides this via the .chezmoi.username template variable.
    real_user="{{ .chezmoi.username }}"
    echo "Script is running as root. Assuming user is '$real_user'."
    install_packages
    set_default_shell "$real_user"
else
    # When run as a normal user, use sudo for privileged operations.
    echo "Script is running as user '$USER'. Using sudo for privileged operations."
    install_packages
    set_default_shell "$USER"
fi

# --- Server-specific configurations ---
echo -e "${YELLOW}Configuring server-specific settings...${NC}"
# Add server-specific configurations here as needed
# For example:
# - Configure firewall settings
# - Set up server monitoring
# - Configure SSH settings

echo -e "${GREEN}RHEL/Alma Linux bootstrap complete! Restart your shell to use ZSH.${NC}"
